<!-- markdown-toc start - Don't edit this section. Run M-x markdown-toc-generate-toc again -->
**Table of Contents**

- [Введение](#введение)
- [Решаемые задачи](#решаемые-задачи)
- [Решение в лоб](#решение-в-лоб)
- [Проблемы](#проблемы)
- [Управление конфигурацией](#управление-конфигурацией)
- [Ключевое в Ansible](#ключевое-в-ansible)
- [Обучение](#обучение)

<!-- markdown-toc end -->

Введение
========

Управление конфигурации является очень важным процессом, который находится на
стыке между разработкой и администрированием.

Решаемые задачи управлением конфигурациями достаточно широки.

Они включают в себя на стройку серверной инфаструктуры, причем это не
обязательно какая-то инфаструктура из серверов на которую нужно зайти и
поставить на них определенный софт

Это в том числе и настройка облачной инфраструктуры, особенно учитывая в
последнее время распространение облаков

Это например amazon, google cloud, на которых, перед тем как собственно настраивать
сервера, вам сначала нужно их создать.

Решаемые задачи
===============

* Настройка облачной инфаструктуры
* Настройка серверной инфраструктуры
* Настройка локальной среды для разработки
* Деплой

Делается это обычно в визуальном интерфейсе, когда вы натыкиваете какие-то
параметры, у вас веб балансеры, сервера, почта и много много другое.

Соответственно системы управления конфигурациями позволяют это автоматизировать
и воспроизводить, то есть то что вы настроете один раз, вы потом сможете
использовать многократно.

Естественно стандартная история, с которой начиналась управление конфигурациями
это обычно серверная инфоструктура, на который вам нужно накатывать какой-то
софт, обновлять его, и вообще следить за тем как все работает и происходит.

Кроме этого управление конфигурациями нужны и для локальной среды, для того
чтобы развернуть все что нужно для разработки.

Это довольно очередо и не всегда просто.

Очень часты ситуации, когда человек приходит в компанию, он тратит три дня.

И ему выделяют три дня на то, чтобы он развернул приложения.

При этом скорее всего нет README о том, как это сделать.

А если оно и есть, то оно устаревает.

Потому что вообщем то любая документация всегда устаревает

Особенно та которая не пользуется внешним спросом, а используется только внутри
команды.

И это не очень приятно, когда приходится постоянно это делать.

Обычно такие люди пытаются как раз что то изменить, но потом когда они в конце
концов, это забывается.

И все повторяется снова с приходом нового человека.

Кроме этого локальная среда все же должна максимально соответствовать production
среде.

И было бы очень здорово, если бы одна и та же настройка, могла работать и там и
там, и не пришлось бы их независимо описывать и независимом настривать.

Кроме этого деплой (выкладка кода на production), или может быть на staging, это
в общем то тоже процесс, который является частью управления конфигурациями.

Потому что по сути это обновление серверного программного обеспечения.

Только здесь уже программое обеспечение - это то, что вы уже сами
непосредственно разрарабатываете.

Не все системы управления конфигурациями позволяют это делать удобно, но Ansible
позволяет это делать достаточно хорошо, и вообще есть тенденция, эмиграция
специализированных инструментов, которые существуют в конкретных языках
программирования на Ansible

Потому что-то этот способ является более универсальным и особенно он хорош,
когда у вас гитрогенная среда с различными сервисами на разных языках и
совершенно разными стэками.

То есть например Java, Ruby, и так далее.

Когда они между собой слабо пересекаются, но при этом присутствует у вас в одной
экосистеме машин.

Решение в лоб
=============

* Ручное конфигурирование
* Исправления прямо на целевых машинах
* Написание bash скриптов

Какие решения можно придумать влоб для решения предыдущих задач?

Что можно сделать, и как это общем то изначально делать

Первый это ручное конфигурирование, когда вы просто по необходимости делайте
правки, которые вам нужны.

Кроме того что они делаются руками, они еще и делаются чаще всего на целевых
машинах.

То есть вы просто заходите и прям там делаете конфигурации Nginx, перезапуск и
так далее.

Что естественно видет к большому количеству проблем.

Более продвинуты способ, но тоже обладающий почти всеми теми же недостатками,
это написание своих собственных bash скриптов.

Так тоже можно делать, так тоже многие делают.

Особенно старые админы, которые где-то долго работают на одном месте, у них с
собой есть целая пачка скриптов, которые они переиспользуют и держат обычно в
секрете от всех остальных.

Проблемы
========

Но все эти подходы имеют большие недостатки.

Во первых, при таком подходе, когда все делается руками, все сервера немного
разные.

Потому что если у вас существуют какая-то экосистема, где более одного сервера,
то делать синхронные изменения и контролировать, то что они выполняються
одноврменно везде достаточно сложно.

В любом случае кто-нибудь случайно зайдет и поменяет где-нибудь в одном месте,
забыв синхронизировать это с другим местом.

Это можно пытаться контролировать, но все будет упираться в человеческий фактор.

В конце концов они все равно будут расходиться, что стопроцентно будет приводить
проблемам.

Второй момент крайне важный, то что очень сложно воспроизвести конфигурацию.

То есть если у вас ложится по какой причине машина, то поднять ее будет может
быть даже невозможно, в таком же виде, в котором она была.

Потому что ее конфигурация, настройка софта, может быть раскина по всей файловой
структуре.
 
И очень сложно вспомнить, и вообще это неправильно, пытаться вспомнить, что там
такое было.
 
Есть случаи когда люди, вместо того чтобы достаточно быстро, в течение 20 минут,
что позволяют современные средства виртуализации, поднять новую виртуальную
машину, тратят много суток, на то, чтобы вспомнить все настройки, отладить их
снова и запустить.

И плавно мы приходим соответственно к следующему пункту, нет контроля изменений,
то есть вы даже не сможете понять, что пошло не так.

Если кто то где то что-то поменял, например сработала система мониторинга
алертов, что-то не работает, то чтобы воспроизвести ситуацию, вам придется всех,
кто мог что-то менять, поднимать на уши, спрашивать, и всем вместе пытаться
впомнить что же произошло.

Это довольно грустно.

Ну и последнее в этом списке, но не последняя среди проблем это знание хранятся
в головах, и обычно в одной.

Кто-то конкретно знает, как это делать.

Все стараются делать изменение через него.

Или этот человеческ пытаюется отконтролировать.

Соответственно все концентрируются вокруг небольшой группы людей или одного
человека.

Сответствено, если они увольняются, или происходят какие-то изменения, то это
приводит к проблемам.

Потому что нет никакой прозрачной схемы.

Ну и вообще это очень часто отделяет программиста от админа дальше, вместо того,
чтобы их наооборот сближать и делать одной командой.

Управление конфигурацией
========================

* Описание в одном месте
* Инфраструктура как код
* Идемпотентность

Автоматическое управление конфигурациями решает большинство этих проблем.

Вот какими способоми.

Во первых вы описываете все в одном месте.

Ваши конфигурации не разбросаны где-то по серверам, а это будет какой-то
репозиторий, в котором лежит код, описание.

Вы в любой момент видите, что у вас было, в какой момент, и что сейчас находится
на сервере.
 
Второй пункт это инфраструктура как код, это очень важный аспект, означающий,
что теперь вы не производите вообще никаких изменений руками.
 
Вы пишете код, который потом с помощью специальных систем применяется.

И таким образом ваши конфигурации эволюционируют, но по факту вы пишите код.

И от этого вы получаете все преимущества, которые существуют в системах контроля
версий, потому что код можно держать именно там.

Вы можете видеть и вы видите, что будет если...

Что было?

То есть какие были изменения и любое изменение приводит к тому, что все в любой
момент могут легко понять, что происходит.

Соответственно можно напрямую через pull request разрабатывать и таким образом
контролировать изменения на серверах.

Но и множество других очень клевых фишек открывается с тем, когда вы начинаете
использовать инфраструктуру как код.

Ественно в таком случае поднять новый сервер становится тривиальной задачей
потому, что вот у вас ваша конфигурация, вы просто ее накатываете и все работает.

После этого вернуться к обратному ручному конфигурированию просто невозможно
потому, что это настолько хорошо и насколько удобно, что люди которые это
опознали, им сложно представить что можно как-то делать по другому.

И есть еще один последний элемент в этом списке, но не последний по важности.

Это идемпотентность.

Что это означает?

Повторный запуск настройки конфигурации, в хорошей системе конигурации, которая
делает изменения на ваших серверах, приводит к crash.

Если вы попытаетесь написать, например bash скрипт, который устанавливает софт,
делает какие-то изменения, то большое количество команд в нем не является
идемпотентными.

Например создание директорий, создание simlink, еще множество других команд.

Тоесть что это означает.

Повторное выполнения этой команды придет к сбою.

В соответствии если вы пишете bash скрипты, вам придется руками все это
разруливать и делать все необходимые проверки.

И вот это один из самых злых факторов, который создает не поддерживаемые,
сложные скрипты, которые достаточно сложно довести до рабочего состояния.

К счастью системы управления конфигурациями декларируют идемпотентность, как
одну из своих главных фишек и они берут ее почти полностью на себя.

Естественно не все ситуации можно разрулить легко.

Но в большей степени они за вас решают эту проблему.

Ключевое в Ansible
==================

* Для работы нужен только ssh
* Описание состояния в yml файлах
* Множество модулей из коробки
* Легко начать

Что есть ключевого в ansible?

Потому что управление конфигурацией - это общая история, но... существует
множество различных систем, и вот на текущий момент ansible является одной из
самых приятных систем в использовании, особенно для тех, кто работал с такими
монстрами, как chef и puppet.

У которых есть конечно свои преимущества.

Они хорошо работают на больших системах.

Но простота и удобство использования ansible, конечно привлекает все больше и
больше как разработчиков, так администраторов.

Во первых для работы с ansible нужнен только установленной ansible на той
машине, с которой вы делаете все изменения.

А чаще всего это ваша локальная машина для разработки.

Так вот когда ansible идет на другую машину, чтобы выполнить там команды, ему
ничего не нужно кроме ssh.

Вам не нужно ничего ставить на другие машины.

Например агенты, как нужно в случае chef или puppet.

Во вторых ansible отличается от многих других систем тем, что у него используются декларативно описание состояние машины.

То есть вы не используйте какой-то язык конкретный.

Если мы опять же берем chef и puppet, вы описываете там состоянии машина на языке ruby.

Что во первых не для всех удобно с одной стороны.

А во вторых у вас полноценный turring полной язык, что приводит к совершенно не поддержим коду очень часто.

Потому, что например администраторы не всегда программисты.

Плюс полная свобода действий может сыграть с вами злую шутку.

Да конечно, когда у вас есть, как ограниченное описание, вы не всегда легко
можете выразить что что не задумывалась.

Но для 90 процентов случаев стандартных задач, это намного удобнее потому, что у
вас будет единообразие полное на всех уровнях.

Ну и плюс никакого языка программирования.

Все достаточно просто, особенно учитывая, что yml файлы очень распространенный и
понятный формат для всех, кто хоть как-то с разработкой сталкивается.

Кроме этого, ansible отличается от других систем тем, что они из коробки
предоставляют гигантское количество модулей.

Этих модулей сотни и они покрывают все.

Это не только базовые настройки операционной системы, которые являются общими для всех.

Ansible сразу умеет работать с docker, базами данных, системами мониторинга,
alerting, облаками и всем что только можно вообразить.

Поэтому используя ansible, вы просто сразу можете начать делать все, что вам
нужно, без попытки искать каких-то дополнений для того, чтобы завести даже
какие-то простейшие задачи.

Но и последние в списке из ключевых особенностей ansible - это то, что с ним
очень легко начать.

В отличие опять же от многих других систем, которые требуют для своей первичной
конфигурации, огромных количество шагов.

И через которые, кстати говоря многие вообще пройти даже не могут.

Просто потому, что их это останавливает.

То ansible в своем базовом варианте можно начать использовать, не создавая
вообще ни одного файла.

Это подкупает очень сильно, и это действительно позволяет очень легко войти
в него.

То есть вам не нужно знать очень много и очень глубоко эту систему для того,
чтобы начать использовать.

Более того, так называемые playbook - это yml файлы, в которых описывается
конфигурация.

Они очень сильно похоже на тот же самый bash скрипт, который бы вы написали.

Да это yml, это не bash конечно, но структура будет очень похожая.

При этом вы получаете все те плюшки, о которых мы говорили и не будет создано
никакого дополнительного... никаких дополнительных файлов, никакой
дополнительной предустановки, которая требовалась бы с более сложными системами.

Поэтому ansible это не та система, которую нужно начинать использовать, если
количество ваших серверов превышает 10 штук.

Ansible на столько прост и на столько удобен, что его надо использовать даже
если вы один, и даже если вы работаете просто на локальной машине и вас даже нет
продакшна.

Потому что настройка собственной локальной среды - это уже проблема, которую можно решить полностью и целиком с помощью ansible.

Обучение
========

* Тесты
* В выводе всегда содержится сообщение об ошибке

Что касается текущего курса.

Тесты, проверяющие то как вы выполняите задачи с помощью ansible, написанны на самом ansible.

И это тоже здорово, потому что ansible хорошо подходит для того, чтобы
верифицировать то что делается им самим же.

То есть он может легко... его модули легко позволяют проверять текущее состояние
системы.

С одной стороны это страны очень удобно, с другой стороны есть определенная особенность в том, что запуская тесты, вы будете видеть ansible.

Он иногда может быть достаточно подробный, поэтому в нем нужно выискивать где
написано об ошибке.

Но и соответственно это будет вам помогать понимать ansible глубже, потому что
вы будете постоянно видеть его вывод.

:PROPERTIES:
:ID:       58fafa35-7cfa-4a4e-a703-153d03a386c6
:END:
To get LAN mode: ipmitool raw 0x30 0x70 0x0c 0.
To set LAN mode dedicated: ipmitool raw 0x30 0x70 0x0c 1 0.
To set LAN mode onboard/shared: ipmitool raw 0x30 0x70 0x0c 1 1.
To set LAN mode failover: ipmitool raw 0x30 0x70 0x0c 1 2.

- IPMI reset password to default (login is ADMIN)
  : ipmitool -I open lan set 1 password ADMIN

* ipmitool

[[https://habr.com/ru/post/263091/][HA-Cluster на основе Pacemaker под контейнерную виртуализацию LXC и Docker / Хабр]]

Сеть для ipmi желательно вынести в отдельный vlan, во первых это позволит её
изолировать, во вторых не будет проблем со связностью, если IPMI BMC
(baseboard management controller) разделяет сетевой интерфейс с сервером.

#+begin_example
  impitool> lan set 1 ipsrc static
  impitool> lan set 1 ipaddr 10.1.15.1
  impitool> lan set 1 netmask 255.255.255.0
  impitool> lan set 1 defgw ipaddr 10.1.15.254
  impitool> lan set 1 vlan id 314
  # настройка доступа:
  impitool> lan set 1 access on
  impitool> lan set 1 auth ADMIN MD5
  ipmitool> channel setaccess 1 2 callin=on ipmi=on link=on privilege=4
#+end_example

#+begin_example
  ipmitool -I lan -U admin -P 'очень секретный пароль' -H 10.1.15.1 bmc info
#+end_example

* Links
- [[https://github.com/DrSpeedy/ipmi_fancontrol-ng][DrSpeedy/ipmi_fancontrol-ng: IPMI Fan Control Daemon]]
- [[https://www.tzulo.com/crm/knowledgebase/47/IPMI-and-IPMITOOL-Cheat-sheet.html][IPMI & IPMITOOL Cheat sheet - Knowledgebase - tzulo, inc.]]

IPMI & IPMITOOL Cheat sheet

    156 

What is IPMI?

The Intelligent Platform Management Interface (IPMI) is a standardized computer system interface used by system administrators for out-of-band management of computer systems and monitoring of their operation. Out-of-band is also referred to as LOM (Lights-out management) involves the use of a dedicated management channel for device maintenance.
There are number of options available to manage the device remotely. There are vendor specific server management technologies available. HP’s Integrated Lights-out or iLO, Dell’s Dell Remote Access Controller or DRAC and IBM’s Remote supervisor adapter (RSA) are a few to list. The above listed modules are vendor specific and proprietary. IPMI whereas is vendor-neutral and cross-platform. It is available on Linux distros. The functionality of IPMI can be accessed via IPMItool. IPMItool is a simple command line utility which is used to manage IPMI-enabled devices. IPMItool enables you to manage system hardware components, monitor system health, and monitor and manage the system environment, independent of the operating system.

Cheat sheet

You can install IPMI and IPMItool via yum using the following command:

[root@anm ~]# yum install OpenIPMI OpenIPMI-tools

Make sure that the server is set to start during startup and start the IPMI service.

[root@anm ~]# chkconfig ipmi on 
[root@anm ~]# service ipmi start

We have here some IPMItool commands which can be used in day-to-day operations.

1. Man and help info for IPMItool

ipmitool help 
man ipmitool

2. To check firmware version

ipmitool mc info

3. To reset the management controller

ipmitool mc reset [ warm | cold ]

4. Show field-replaceable-unit details

ipmitool fru print

5. Show sensor output

ipmitool sdr list 
ipmitool sdr type list 
ipmitool sdr type Temperature 
ipmitool sdr type Fan 
ipmitool sdr type ‘Power Supply’

6. Chassis commands

ipmitool chassis status ipmitool chassis identify [] # turn on front panel identify light (default 15s) 
ipmitool [chassis] power soft # initiate a soft-shutdown via acpi 
ipmitool [chassis] power cycle # issue a hard power off, wait 1s, power on 
ipmitool [chassis] power off # issue a hard power off 
ipmitool [chassis] power on # issue a hard power on 
ipmitool [chassis] power reset # issue a hard reset

7. Modify boot device for next reboot

ipmitool chassis bootdev pxe 
ipmitool chassis bootdev cdrom 
ipmitool chassis bootdev bios

8. Logging

ipmitool sel info 
ipmitool sel list 
ipmitool sel elist # extended list (see manpage) 
ipmitool sel clear

9. For remote access, you need to setup user and network settings, either at boot time on the iLO or DRAC card itself, or from the OS via ipmitool: 
Display/reset password for default root user (userid ’2′)

ipmitool user list 1 
ipmitool user set password 2

10. Display/configure lan settings

ipmitool lan print 1
ipmitool lan set 1 ipsrc [ static | dhcp ] 
ipmitool lan set 1 ipaddr {YOUR DESIRED IP}
ipmitool lan set 1 netmask {YOUR NETMASK}
ipmitool lan set 1 defgw ipaddr 10.0.1.1

After configuring the lan settings you should be able to connect remotely using the ‘lan’ interface of IPMItool.
The following is an example:

[root@anm ~]# ipmitool -I lan -U root -H {YOUR DESIRED IP} chassis status

11. Hanging BMC

ipmitool bmc reset cold

12. Change system state

ipmitool -H <ip> -U <user> chassis power <status|on|off|cycle|reset>

13. Get debug info

ipmitool lan print
ipmitool -H <ip> -U <user> shell # get ipmitool shell, type 'help'
ipmitool -H <ip> -U <user> sel list # Show system event log
ipmitool -H <ip> -U <user> sdr # List sensor data

14. Get SOL console

modprobe lanplus # If not yet loaded
ipmitool -H <IP> -U <user> -I lanplus sol activate


Additional cheatsheet commands:


#list users
ipmitool -U <login> -P '<password>' -H <IP> user list

#delete user id
ipmitool -U <login> -P '<password>' -H <IP> user set name <id> ""


#add user

#user password
ipmitool -U <login> -P '<password>' -H <IP> ipmitool user set password <id> blah

#power status
ipmitool -U <login> -P '<password>' -H <IP> power status

#power off
ipmitool -U <login> -P '<password>' -H <IP> power off

#power on
ipmitool -U <login> -P '<password>' -H <IP> power on

#power reset
ipmitool -U <login> -P '<password>' -H <IP> power reset

* Cheat sheet

- host status
  : ipmipower --hostname=web16.ipmi.intr --username=ADMIN --password="$(pass show majordomo/public/ipmi/ADMIN)" --stat

- reboot
  : ipmipower --hostname=web16.ipmi.intr --username=ADMIN --password="$(pass show majordomo/public/ipmi/ADMIN)" --reset
  : ipmitool -I lanplus -H web16.ipmi.intr -U ADMIN -P "$(pass show majordomo/public/ipmi/ADMIN)" power cycle 

- print networking information
  : ipmitool -H web16.ipmi.intr -U ADMIN -P "$(pass show majordomo/public/ipmi/ADMIN)" lan print

- [[https://galaxydata.ru/community/ipmi-sbros-parolya-i-prochee-x8dtu-f-supermicro-188][IPMI сброс пароля и прочее x8dtu-f supermicro - GalaxyData Community]]

* Tools
- [[https://github.com/kontron/python-ipmi][kontron/python-ipmi: A pure python IPMI library]]
- [[https://github.com/yinheli/ipmi-fan-control][yinheli/ipmi-fan-control: A tool to control the fan speed by monitoring the temperature of CPU via IPMI.]]

* [[https://gist.github.com/egernst/66febb5b95a1d303881db05c926e0b63][ipmi serial over lan sol]]
#+begin_src markdown
  ## Pre-requisites

  Install IPMItools using your package manager on laptop and target machine. Load the drivers on the target.

  ```bash
  modprobe ipmi_devintf
  modprobe ipmi_si
  ```

  If you see the following, drivers are not loaded.

  ```
  Could not open device at /dev/ipmi0 or /dev/ipmi/0 or /dev/ipmidev/0: No such file or directory
  ```

  ## IPMI setup

  On the target machine run below commands to setup access - 

  ```bash
  ipmitool lan print 1
  ipmitool lan set 1 ipsrc dhcp
  ipmitool lan print 1
  ```

  Make a note of the IP address from the above output. This will be used to connect from your laptop

  ```bash
  ipmitool user list 1
  ipmitool user set name 3 rockstar
  ipmitool user set password 3
  ```

  You'll get a password prompt. Set the password. `whatcouldgowrong` in our example. Next -

  ```bash
  ipmitool channel setaccess 1 3 link=on ipmi=on callin=on privilege=4
  ipmitool user enable 3
  ipmitool user list 1
  ``` 

  Now from your laptop you can execute commands, like so

  ```bash
  ipmitool -I lanplus -U rockstar -P whatcouldgowrong -H <IP address> chassis power (on|off|status)
  ```

  ## SOL setup

  Enable SOL for root and above user. Enable SOL.

  ```bash
  ipmitool sol payload enable 1 2
  ipmitool sol payload enable 1 3
  ipmitool sol set enabled true 
  # try the below command even if this command fails.
  ```

  Check links 2 and 5 for BIOS and OS configurations necessary.
  In the BIOS, you can also set DHCP hostname for the BMC, frees you from tracking IP addresses.
  To access the SOL console, on your local machine use the activate option as shown.
  Check SOL session help by typing this `~?`. To kill a hung SOL session use deactivate.

  ```bash
  ipmitool -I lanplus -U rockstar -P whatcouldgowrong -H <IP address> sol (activate|deactivate)
  ```

  If everything works you will be able to remotely access the target machine's console and make selections in grub menu, etc.,
  My NixOS config settings that worked

  ```text
  # Use the GRUB 2 boot loader.
  boot = {
   loader.grub = {
   ...
   extraConfig = "serial --speed=115200 --unit=0 --word=8 --parity=no --stop=1; terminal_input serial; terminal_output serial";
   };
  kernelModules=["lanplus" ... ];
  }
  boot.kernelParams = [
   ...
  "console=tty0" "console=ttyS0,115200n8"
  ];
  systemd.services."serial-getty@ttyS0".wantedBy = [ "multi-user.target" ];
  ```

  ## Appendix
  1. http://www.openfusion.net/linux/ipmi_on_centos
  2. http://tech.sid3windr.be/2016/02/configuring-ipmi-serial-over-lan-on-debian-8-jessie/
  3. https://discuss.pivotal.io/hc/en-us/articles/206396927-How-to-work-on-IPMI-and-IPMITOOL
  4. https://wiki.hetzner.de/index.php/IPMI/en
  5. http://wiki.drewhess.com/wiki/IPMI_and_SOL_on_an_Intel_S3200SHV
#+end_src

https://gist.github.com/egernst/66febb5b95a1d303881db05c926e0b63?permalink_comment_id=4189594#gistcomment-4189594
#+begin_src markdown
  For whoever next stumbles upon this, I also had to set

  admin sol set non-volatile-bit-rate 115.2
  admin sol set volatile-bit-rate 115.2

  BIOS settings (Asrock E3C236D2I) were apparently misleading
#+end_src

** [[https://tech.sid3windr.be/2016/02/configuring-ipmi-serial-over-lan-on-debian-8-jessie/][Configuring IPMI Serial-over-LAN on Debian 8 (Jessie) – Tom's Tech Blog]]
*** Configuring IPMI Serial-over-LAN on Debian 8 (Jessie)
Posted on [[https://tech.sid3windr.be/2016/02/configuring-ipmi-serial-over-lan-on-debian-8-jessie/][February 24, 2016February 24, 2016]] by [[https://tech.sid3windr.be/author/tom/][Tom Laermans]]

*** What is IPMI? Why still use a serial console?
While your desktop or laptop at home isn’t all that far away from you, a
server in a remote datacenter isn’t usually within reach. In case of issues
with the machine or its operating system, it might be handy to have access to
its keyboard and mouse inputs and video output to diagnose boot errors, kernel
panics and all that sort of thing. On decent servers, a Baseboard Management
Controller (BMC) exists, which speaks the IPMI protocol. This allows you to
reboot a machine, power it up or down, read out some sensor data, etc. On
modern servers, this function is supplemented by a web server which can also
serve you the same data through your browser, which makes things a little more
accessible. Even better if there’s a way to reach the KVM (Keyboard, Video,
Mouse) from there.

This isn’t always the case however. On HP servers, to access this after the OS
has booted requires an “iLO Advanced License” which may not be in your budget,
or simply not activated on that one older server you’re still using. Older
servers, like ones based on Supermicro’s IPMI 2.0 add-in boards simply don’t
have this function. Or you may have a BMC which uses a Java applet to show you
the KVM, which no longer works with a recent Java version, or even worse, it’s
an ActiveX object that only works in IE6!

Have no fear, there’s another nice function that IPMI v2.0 provides:
Serial-over-LAN. For a Windows server, that likely doesn’t mean much, but for
a Linux server, we can definitely make use of this. I’ll be using Debian in
this article, but the same will go for Ubuntu (likely with identical commands
and files) and any other Linux distribution (which may use different paths,
commands, etc).

After setting this up for one of my home test servers that’s usually powered
off, I’ve used it many times to watch its boot process remotely – It’s got 5
RAID controllers installed, so booting takes a while.

*** Prerequisites
For this set-up I will assume you have configured your IPMI card to be
remotely accessible (IP address, gateway, etc), with a user configured. You
can try this out fairly easily from a remote machine:

#+begin_example
  debian:~# ipmitool -H <ip address> -U <username> chassis status
  Password:
  System Power : on
  Power Overload : false
  (...)
#+end_example

This example is based on Debian “Jessie” 8.0 running on a Supermicro
AOC-IPMI20-E (“BMC2”) on a X6DH8 board. It’s old, but set up should be fairly
identical on newer machines. This BMC does not have remote KVM access at all,
so Serial-over-LAN is the only way to get any access to the OS through the
management controller.

On my old (2006!) Supermicro card, I had to upgrade the firmware from “IPMI
2.0 RCMP” to “IMPI 2.0 RCMP+” for Serial-over-LAN to work. This is because
that feature was formally introduced in RCMP+ – some BMCs (Tyan, Intel,
Supermicro) had custom extensions so some of their IPMI 1.5 controllers could
already do it.

Try to connect to the IPMI serial port (using the “LAN Plus” interface, which
means IPMI 2.0, as the default “LAN” interface is IPMI 1.5):

#+begin_example
  debian:~# ipmitool -H <ip address> -U <username> -I lanplus sol activate
  Password:
  [SOL Session operational. Use ~? for help]
#+end_example

Unless you already have something configured to speak serial, things will just
stay blank there. Exiting that SOL session can be done by typing “~.” like
typing “~?” will tell you.

You can find the correct bit rate using the sol info command:

#+begin_example
  debian:~# ipmitool -H <ip address> -U <username> -I lanplus sol info 1
  (...)
  Volatile Bit Rate (kbps) : 19.2
  Non-Volatile Bit Rate (kbps) : 19.2
  (...)
#+end_example

On my old card I can’t seem to change the serial speed; if you can, I do
recommend setting it to 115200bps as it’ll very much speed up your boot
process. You can try doing this using ipmitool sol set volatile-bit-rate
115.2. If you succeed at changing this, be sure to replace 19200 by the
bitrate you’re using in all commands and settings used below.

I used “screen /dev/ttySx 19200” on the server to find the correct serial port
that is connected to the BMC – in my case (I think on all Supermicro boards)
this was /dev/ttyS1 aka COM2. Just type something into the screen session, and
if you see it appear on your remote IPMI Serial-over-LAN, you found the
correct port.

*** Sending your BIOS output to the serial port
This is very likely Supermicro-specific, but setup for your board should be
very similar. As we’ve established COM2 was the correct serial port, we enable
Remote Access to the BIOS over COM2 (“COM B” in Supermicro BIOS), using 19200
8n1 serial settings.

[[http://tech.sid3windr.be/wp-content/uploads/2016/02/bios-advanced-options.png]]

[[http://tech.sid3windr.be/wp-content/uploads/2016/02/bios-console-redirection.png]]

Make sure to disable “Enable Console Redirection after POST” in the BIOS setup
not to conflict with GRUB’s serial terminal code.

Using this setup, you can even control your RAID controller BIOSes or
similar. Of course, if this controller has a graphical interface (like
LSI/Intel has), that won’t pass over the serial link. Boo!

You can even do a PXE boot, but once the PXE image has booted, it’ll have to
do its own serial port output (unless you enable “Enable Console Redirection
after POST”).

*** Sending your GRUB2 output to the serial port
Open /etc/default/grub and change the following settings:

#+begin_example
  GRUB_TERMINAL="serial console"
  GRUB_SERIAL_COMMAND="serial --speed=19200 --unit=1 --word=8 --parity=no --stop=1"
#+end_example

Important note: that “serial console” isn’t a text string to tell GRUB2 to use
a serial console. They’re 2 distinct words; as contrary to GRUB 0.x, GRUB2
supports 2 simultaneous I/O terminals – “serial” for the serial port,
“console” for the machine’s native monitor/keyboard console.

In GRUB_SERIAL_COMMAND, “--unit=1” means ttyS1 aka COM2.

After changing the configuration, be sure to run update-grub – but check the
next section first, as there actually is some more work to do.

*** Sending your Linux kernel output to the serial port
Open /etc/default/grub and modify the GRUB_CMDLINE_LINUX_DEFAULT line:

: GRUB_CMDLINE_LINUX_DEFAULT="console=tty0 console=ttyS1,19200n8"

I would recommend to remove “quiet” to get the full kernel output over your
serial port – if you leave it, you won’t see a whole lot of output on your
serial port at all.

After changing the configuration, be sure to run update-grub.

*** Enabling a serial console login on the serial port
Older HOWTOs likely point you at /etc/inittab – a file which is no longer used
by systemd (which Debian 8 is using). The good news is, if you’ve enabled
GRUB2 to use a serial port, systemd will automatically add a listener on that
serial port.

*** Memtest86+
If you have the memtest86+ package installed, it will automatically add a few
entries to your grub menu to run memtest with serial port support. However, if
your IPMI SOL port speed is not 115200 and/or your serial port is not
ttyS1/COM1, it might be useful to modify /etc/grub.d/20_memtest86. Replace
115200 by your correct bitrate and ttyS0 by the correct serial port. Make sure
to run update-grub after editing this file.

*** Conclusion
If everything went well, you how have a fully serial-controllable system! From
booting the BIOS, to the boot loader, over the Linux kernel out right to the
terminal login prompt, everything is accessible to you via the IPMI serial
console.

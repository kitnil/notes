:PROPERTIES:
:ID:       733b2bb3-34be-4bae-86ea-a64b9e403cfd
:END:
#+title: Wireguard

* Learning
- [[https://habr.com/ru/company/indriver/blog/586006/][WireGuard. How it was / Хабр]]

* Configuration

** server

#+begin_example
[Interface]
PrivateKey = 
Address = 10.66.66.1/24
ListenPort = 63665
PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o ens3 -j MASQUERADE
PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o ens3 -j MASQUERADE

[Peer]
PublicKey = 5xGlB3nuDI56LehsK2ILBA99LrQoxZcTWmL1HBGaBCk=
AllowedIPs = 10.66.66.2/32
#+end_example

** client

#+begin_example
[Interface]
PrivateKey = 
Address = 10.66.66.2/32

[Peer]
PublicKey = Q5G8bmBxhuPnoFgELcJpo2SJ+X8kkteHz5xvpbLupwA=
Endpoint = 178.250.247.88:63665
AllowedIPs = 10.66.66.0/24
#+end_example

** docker

[[https://old.reddit.com/r/selfhosted/comments/u1oys9/access_a_docker_container_web_service_only/][Access a Docker container web service only through Wireguard : selfhosted]]

#+begin_src yaml
  version: "3.9"

  services:
    wireguard:
      image: weejewel/wg-easy
      container_name: wireguard
      restart: unless-stopped
      cap_add:
        - NET_ADMIN
        - SYS_MODULE
      environment:
        - WG_HOST=<HOST>
        - PASSWORD=<PASSWORD>
      volumes:
        - ./config:/etc/wireguard
      ports:
        - 51820:51820/udp
      sysctls:
        - net.ipv4.conf.all.src_valid_mark=1
        - net.ipv4.ip_forward=1
      networks:
        - npm

  networks:
    npm:
      external: true
#+end_src

* Cheat sheet

- debug
  : echo module wireguard +p > /sys/kernel/debug/dynamic_debug/control

** Possible issues

*** RX errors on an interface

Origin: [[https://lists.zx2c4.com/pipermail/wireguard/2018-April/002726.html][RX Errors from Android Peer]]

Those RX frame errors are caused by the interface receiving packets
that have a source IP not included in the allowed-ips list of the
peer.

https://git.zx2c4.com/WireGuard/tree/src/receive.c#n351

* Misc
- [[https://github.com/tonarino/innernet][tonarino/innernet: A private network system that uses WireGuard under the hood.]]
- [[https://github.com/WeeJeWel/wg-easy][WeeJeWel/wg-easy: The easiest way to run WireGuard VPN + Web-based Admin UI.]]
- [[https://github.com/juanfont/headscale][juanfont/headscale: An open source, self-hosted implementation of the Tailscale control server]]

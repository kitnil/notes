:PROPERTIES:
:ID:       34e20a86-6b2e-4508-88cf-8a091be96ef5
:END:
- [[https://github.com/libguestfs/libguestfs][libguestfs/libguestfs: library and tools for accessing and modifying virtual machine disk images. PLEASE DO NOT USE GITHUB FOR ISSUES OR PULL REQUESTS. See the website for how to file a bug or contact us.]]
- [[https://github.com/BigAnteater/KVM-GPU-Passthrough][BigAnteater/KVM-GPU-Passthrough: This is a simple, mostly automated guide to pass a GPU through to a VM.]]
- [[https://github.com/virt-manager/virt-manager/pull/233][Undecorated window by bazsi · Pull Request #233 · virt-manager/virt-manager]]
- [[https://github.com/abbbi/virtnbdbackup][abbbi/virtnbdbackup: Backup utiliy for Libvirt / qemu / kvm supporting incremental and differencial backups.]]
- [[https://github.com/JonathonReinhart/spice-record][JonathonReinhart/spice-record: Record SPICE session output to MP4 video]]
- [[https://github.com/Jiab77/libvirt-web][Jiab77/libvirt-web: A simple web interface based on libVirt and PHP.]]
- [[https://github.com/saschpe/libvirt-hook-qemu][saschpe/libvirt-hook-qemu: Libvirt hook for setting up iptables port-forwarding rules when using NAT-ed networking.]]

* virt-manager

#+begin_example
  qemu+tcp://kvm15.intr/system
#+end_example

* Add cdrom

  #+begin_src bash
    virsh -c qemu+tcp://HOST/system edit vm12345
  #+end_src

  #+begin_src xml
    <disk type='file' device='cdrom'>
      <driver name='qemu' type='raw'/>
      <source file='/kvm/artix-xfce-s6-20200506-x86_64.iso'/>
      <target dev='hdc' bus='ide'/>
      <readonly/>
      <address type='drive' controller='0' bus='1' unit='0'/>
    </disk>
    <!-- ... -->
    <boot dev='hd'/>
    <boot dev='cdrom'/>
  #+end_src

  #+begin_src bash
    virsh -c qemu+tcp://HOST/system shutdown vm12345
    virsh -c qemu+tcp://HOST/system start vm12345
  #+end_src

** VNC
#+begin_src xml
  <graphics type='vnc' port='11935' autoport='no' listen='127.0.0.1' keymap='en-us'>
    <listen type='address' address='127.0.0.1'/>
  </graphics>
#+end_src

** Disk configuration
   #+begin_src xml
     <disk type='file' device='disk'>
       <driver name='qemu' type='qcow2'/>
       <source file='/kvm/disks/nixops-dd310333-9f51-11ea-a6e4-0242c6b2ca1a-web98.qcow2'/>
       <target dev='hda' bus='ide'/>
       <address type='drive' controller='0' bus='0' target='0' unit='0'/>
     </disk>
   #+end_src

* Migrate

#+begin_example
  #!/bin/bash
  # KVM-SSD migrate script

  LANG=en_US.UTF8
  PATH=/usr/local/bin:/usr/bin:/usr/local/sbin:/usr/sbin
  ACCT=$1
  SERV=$2

  f_help() {
    echo "Specify account name and destination host, example:"
    echo "migr_kvm p123456 kvm-ssd1"
    exit 1;
  }

  f_print_err() {
    local message=$1
    [ -n "$message" ] || message="Unknown error"
    echo "=================="
    echo "$message"
    echo "=================="
    exit 255
  }

  ( [ -z $ACCT ] || [ -z $SERV ] ) && f_help

  random_name=$(< /dev/urandom tr -dc A-Za-z0-9_ | head -c8)

  # create backup
  cat /etc/libvirt/qemu/$ACCT.xml > "/usr/local/bin/backup_migrate/$ACCT.xml.$random_name"


  HOST="root@$SERV"
  SIZE=$(lvdisplay /dev/vm/$ACCT | awk '/LV Size/ {print $3}'|sed 's/\,/\./g')
  SSH_OPTS='-o StrictHostKeyChecking=no -o PasswordAuthentication=no '
  MIGR_OPTS="--live --copy-storage-all --verbose --persistent --undefinesource"

  echo "Create disk image on destination server"
  ssh $SSH_OPTS $HOST -t "[ -b /dev/vm/$ACCT ] || /usr/sbin/lvcreate -V${SIZE}G -T vm/pool -n$ACCT" || f_print_err "Error: creation lvm"
  echo "Start migrate CT $ACCT to $SERV"
  virsh migrate $MIGR_OPTS $ACCT qemu+ssh://$SERV/system  tcp://$SERV/ || f_print_err "Error on steep: virsh migrate"
  echo "Waiting for trim start..."
  sleep 10
  ssh $SSH_OPTS $HOST -t "/usr/bin/virsh qemu-agent-command $ACCT --timeout 60 '{\"execute\":\"guest-fstrim\"}' >/dev/null 2>&1"
  echo "Migration completed"

#+end_example

#+begin_example
  #!/bin/bash

  for i in `/usr/bin/virsh list|grep run|awk '{print $2}'`; do
      /usr/bin/virsh qemu-agent-command $i --timeout 60 '{"execute":"guest-fstrim"}';
  done
#+end_example

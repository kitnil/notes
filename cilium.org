: kubectl create deployment nginx --image=nginx
: kubectl expose deployment nginx --port=80

#+begin_src yaml
  apiVersion: networking.k8s.io/v1
  kind: NetworkPolicy
  metadata:
    name: access-nginx
  spec:
    podSelector:
      matchLabels:
        app: nginx
    ingress:
    - from:
      - podSelector:
          matchLabels:
            access: "true"
#+end_src

* Cheat sheet

- [[https://www.youtube.com/watch?v=Kmm8Hl57WDU][(83) Understanding and Troubleshooting the eBPF Datapath in Cilium - Nathan Sweet, DigitalOcean - YouTube]]
  - [[https://static.sched.com/hosted_files/kccncna19/20/eBPF%20and%20the%20Cilium%20Datapath.pdf][eBPF and the Cilium Datapath.pdf]]

- list all endpoints on a node, show if if has ingress and egress policy attached, and give endpoint id
  : cilium endpoint list

- tcpdump like.  It allows to monitor even specific sockets within one endpoint or just specific endpoints themselfs.
  : cilium monitor

- dump all bpf network device programs that are attached
  : bpftool net

* Learning
- [[https://nicovibert.com/2022/07/21/bgp-with-cilium/][BGP with Cilium]]
- [[https://isovalent.com/blog/post/cilium-release-112/#ingress][Cilium 1.12 - Ingress, Multi-Cluster, Service Mesh, External Workloads, ...]]
- [[https://isovalent.com/data/multi-cluster-ebook.pdf][multi-cluster-ebook.pdf]]
- [[https://cilium.io/blog/2019/03/12/clustermesh/][Deep Dive into Cilium Multi-cluster]]
- [[https://docs.cilium.io/en/stable/gettingstarted/clustermesh/clustermesh/][Setting up Cluster Mesh — Cilium 1.12.4 documentation]]
- [[https://scribe.bus-hit.me/codex/establish-cilium-clustermesh-whelm-chart-11b08b0c995c][Establish Cilium ClusterMesh wHelm Chart]]
- [[https://github.com/cilium/cilium/issues/18932][docs: Adding a note for required configuration to create a host-only network with latest VirtualBox · Issue #18932 · cilium/cilium]]

* Debug

1. LB IP is assigned to the service (kubectl get svc).
2. Cilium has properly provisioned services (cilium bpf lb list).
3. What happens with a request (cilium monitor).

* Tools
- [[https://editor.cilium.io/?id=sGIKib2OwOtkkypE][Network Policy Editor for Kubernetes]]
- [[https://jenkins.cilium.io/][Cilium Jenkins Instance]]
- [[https://github.com/cilium/cilium-cli][cilium/cilium-cli: CLI to install, manage & troubleshoot Kubernetes clusters running Cilium]]

** Hubble relay

[[https://docs.cilium.io/en/v1.9/gettingstarted/hubble/][Networking and security observability with Hubble — Cilium 1.9.18 documentation]]

: kubectl port-forward -n kube-system svc/hubble-relay --address 0.0.0.0 --address :: 4245:80
